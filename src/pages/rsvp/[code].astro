---
export const prerender = false;

import { createClient } from "@supabase/supabase-js";
import Card from "../../components/Card.astro";
import PageContainer from "../../components/PageContainer.astro";
import RsvpForm from "../../components/RsvpForm";
import Layout from "../../layouts/Layout.astro";

const { code } = Astro.params;

const supabase = createClient(
	import.meta.env.SUPABASE_URL,
	import.meta.env.SUPABASE_KEY,
);

const { data } = await supabase
  .from("rsvps")
  .select(`
    primary_name,
    plus_one_allowed,
    primary_attending,
    plus_one_attending,
    plus_one_name,
    submitted_at
  `)
  .eq("invite_code", Number(code));

console.log(12231231, data);

const guest = data?.[0];
---

<Layout title="RSVP">
  <PageContainer maxWidth="lg">
    <Card>
      <h1 class="text-4xl sm:text-5xl mb-6 text-pink-600">RSVP</h1>

      {!guest && (
        <p class="text-gray-600">
          Sorry — we couldn't find that invite code.
        </p>
      )}

      {guest && guest.submitted_at && (
        <div class="space-y-4">
          <p class="text-gray-600">
            Hi {guest.primary_name}!
          </p>
          <p class="text-gray-600">
            We've already received your RSVP — thank you!
          </p>

          <div class="rounded-lg bg-gray-50 p-4 text-sm text-gray-700">
            <p>
              <strong>Attending:</strong>{" "}
              {guest.primary_attending ? "Yes" : "No"}
            </p>

            {guest.primary_attending && guest.plus_one_attending && (
              <p>
                <strong>Plus one:</strong> {guest.plus_one_name}
              </p>
            )}
          </div>
        </div>
      )}

      {guest && !guest.submitted_at && (
        <RsvpForm
          client:load
          name={guest.primary_name}
          plusOneAllowed={guest.plus_one_allowed}
          inviteCode={code}
        />
      )}
    </Card>
  </PageContainer>
</Layout>
